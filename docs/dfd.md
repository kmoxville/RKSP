# DFD-диаграмма (нотация Гейна-Сарсона)

**Система обработки событий университета**

---

## Контекстная диаграмма (уровень 0)

```mermaid
flowchart LR
    User[Пользователь]
    Sys["Система обработки<br/>событий университета"]
    User -->|"События (JSON)"| Sys
    User -->|"Запрос подсчёта"| Sys
    Sys -->|"Количество записей"| User
```

---

## Диаграмма 1 уровня

```mermaid
flowchart TB
    subgraph External
        User[Пользователь]
    end

    subgraph Processes
        P1["1.0 Приём событий<br/>(ingest-service)"]
        P2["2.0 Обработка и сохранение<br/>(processor-service)"]
        P3["3.0 Подсчёт и агрегация<br/>(processor-service)"]
    end

    subgraph Storage
        D1[("D1<br/>RabbitMQ<br/>events.raw")]
        D2[("D2<br/>PostgreSQL<br/>raw_university_events")]
        D3[("D3<br/>ClickHouse<br/>events_aggregates")]
    end

    User -->|"POST /events<br/>JSON события"| P1
    P1 -->|Сообщение| D1
    D1 -->|Сообщение| P2
    P2 -->|Запись| D2
    User -->|"POST /events/count"| P3
    D2 -.->|"SELECT count()"| P3
    P3 -->|Агрегат| D3
    P3 -->|"{count: N}"| User
```

**Потоки данных:**

| № | От | К | Данные |
|---|----|---|--------|
| 1 | Пользователь | 1.0 | POST /events, JSON (ФИО, дисциплина, аудитория, дата) |
| 2 | 1.0 | D1 | Сообщение в очередь RabbitMQ |
| 3 | D1 | 2.0 | Сообщение из очереди |
| 4 | 2.0 | D2 | Запись в PostgreSQL |
| 5 | Пользователь | 3.0 | POST /events/count |
| 6 | D2 | 3.0 | Запрос count в PostgreSQL |
| 7 | 3.0 | D3 | Вставка (дата, количество) в ClickHouse |
| 8 | 3.0 | Пользователь | Ответ {count} |

---

## Диаграммы 2 уровня

### Декомпозиция процесса 1.0 «Приём событий»

```mermaid
flowchart TB
    User[Пользователь]
    P1_1["1.1 Принять HTTP-запрос"]
    P1_2["1.2 Валидировать JSON"]
    P1_3["1.3 Отправить в очередь"]
    D1[("D1 RabbitMQ events.raw")]

    User -->|"POST /events, JSON"| P1_1
    P1_1 -->|"JSON-событие"| P1_2
    P1_2 -->|"Валидный JSON"| P1_3
    P1_3 -->|"Сообщение"| D1
    P1_1 -.->|"202 Accepted"| User
```

### Декомпозиция процесса 2.0 «Обработка и сохранение»

```mermaid
flowchart TB
    P2_1["2.1 Получить сообщение"]
    P2_2["2.2 Сохранить в БД"]
    D1[("D1 RabbitMQ events.raw")]
    D2[("D2 PostgreSQL raw_university_events")]

    D1 -->|"Сообщение"| P2_1
    P2_1 -->|"Десериализованное событие"| P2_2
    P2_2 -->|"Запись"| D2
```

### Декомпозиция процесса 3.0 «Подсчёт и агрегация»

```mermaid
flowchart TB
    User[Пользователь]
    P3_1["3.1 Выполнить подсчёт"]
    P3_2["3.2 Записать агрегат"]
    P3_3["3.3 Сформировать ответ"]
    D2[("D2 PostgreSQL")]
    D3[("D3 ClickHouse events_aggregates")]

    User -->|"POST /events/count"| P3_1
    D2 -.->|"SELECT count()"| P3_1
    P3_1 -->|"count"| P3_2
    P3_1 -->|"count"| P3_3
    P3_2 -->|"Агрегат"| D3
    P3_3 -->|"{count}"| User
```

---

## Мини-спецификации (процессы 2 уровня)

### Процесс 1.1 «Принять HTTP-запрос»

| Поле | Описание |
|------|----------|
| **Вход** | POST /api/v1/events с телом JSON |
| **Выход** | JSON-событие (в процесс 1.2); HTTP 202 Accepted (клиенту) |
| **Логика** | Получить запрос, извлечь тело, проверить Content-Type. При успехе передать JSON далее; ответить 202. |

### Процесс 1.2 «Валидировать JSON»

| Поле | Описание |
|------|----------|
| **Вход** | JSON-событие |
| **Выход** | Валидный JSON (в процесс 1.3) |
| **Логика** | Проверить наличие полей fio_prepodavatelya, disciplina, auditoriya, data_sobytiya. Проверить типы и форматы. При ошибке — 400 Bad Request. |

### Процесс 1.3 «Отправить в очередь»

| Поле | Описание |
|------|----------|
| **Вход** | Валидный JSON-событие |
| **Выход** | Сообщение в D1 (RabbitMQ, events.raw) |
| **Логика** | Сериализовать JSON в сообщение, опубликовать в очередь events.raw. |

### Процесс 2.1 «Получить сообщение»

| Поле | Описание |
|------|----------|
| **Вход** | Сообщения из D1 (очередь events.raw) |
| **Выход** | Десериализованное событие (в процесс 2.2) |
| **Логика** | Подписка на очередь, получение сообщения, парсинг JSON в объект. ACK после успешной обработки. |

### Процесс 2.2 «Сохранить в БД»

| Поле | Описание |
|------|----------|
| **Вход** | Десериализованное событие |
| **Выход** | Запись в D2 (таблица raw_university_events) |
| **Логика** | INSERT в raw_university_events (fio_prepodavatelya, disciplina, auditoriya, data_sobytiya). |

### Процесс 3.1 «Выполнить подсчёт»

| Поле | Описание |
|------|----------|
| **Вход** | Запрос POST /events/count; чтение из D2 |
| **Выход** | Значение count (в процессы 3.2 и 3.3) |
| **Логика** | SELECT count(*) FROM raw_university_events. Передать результат далее. |

### Процесс 3.2 «Записать агрегат»

| Поле | Описание |
|------|----------|
| **Вход** | count от процесса 3.1 |
| **Выход** | Запись в D3 (events_aggregates) |
| **Логика** | INSERT (data_vremya_zapisi = now(), kolichestvo_zapisey = count) в ClickHouse. |

### Процесс 3.3 «Сформировать ответ»

| Поле | Описание |
|------|----------|
| **Вход** | count от процесса 3.1 |
| **Выход** | JSON {count: N} пользователю |
| **Логика** | Сериализовать в JSON, вернуть HTTP 200 с телом {"count": N}. |
